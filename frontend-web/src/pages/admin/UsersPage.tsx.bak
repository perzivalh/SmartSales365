import axios from "axios";
import { useCallback, useEffect, useMemo, useState } from "react";
import { useForm } from "react-hook-form";
import { z } from "zod";
import { zodResolver } from "@hookform/resolvers/zod";

import { createCustomer, deleteCustomer, getCustomers, updateCustomer } from "../../api/customers";
import type { CustomerPayload } from "../../api/customers";
import { createUser, deleteUser, getUsers, updateUser } from "../../api/users";
import type { UserPayload } from "../../api/users";
import type { Customer, User } from "../../types/api";
import { Modal } from "../../components/common/Modal";
import { FormInput } from "../../components/form/FormInput";
import { Select } from "../../components/form/Select";

const schema = z.object({
  email: z.string().email("Introduce un email valido."),
  password: z.string().min(6, "La contrasena debe tener al menos 6 caracteres.").optional().or(z.literal("")),
  first_name: z.string().optional().or(z.literal("")),
  last_name: z.string().optional().or(z.literal("")),
  role: z.enum(["ADMIN", "CLIENT"]),
  is_active: z.boolean(),
  phone: z.string().optional().or(z.literal("")),
  doc_id: z.string().optional().or(z.literal("")),
});

type FormValues = z.infer<typeof schema>;
type RoleFilter = "all" | "ADMIN" | "CLIENT";

const defaultValues: FormValues = {
  email: "",
  password: "",
  first_name: "",
  last_name: "",
  role: "CLIENT",
  is_active: true,
  phone: "",
  doc_id: "",
};

const filterControlClass =
  "h-11 w-full rounded-full border border-white/10 bg-white/10 px-4 text-sm font-display font-medium text-white placeholder:text-white/50 transition focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40";
export function UsersPage() {
  const [users, setUsers] = useState<User[]>([]);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [search, setSearch] = useState("");
  const [roleFilter, setRoleFilter] = useState<RoleFilter>("all");
  const [editing, setEditing] = useState<User | null>(null);
  const [isFormOpen, setIsFormOpen] = useState(false);

  const {
    register,
    handleSubmit,
    reset,
    setError: setFormError,
    formState: { errors, isSubmitting },
  } = useForm<FormValues>({
    resolver: zodResolver(schema),
    defaultValues,
  });

  const fetchPeople = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const [usersResponse, customersResponse] = await Promise.all([getUsers(), getCustomers()]);
      setUsers(usersResponse.results);
      setCustomers(customersResponse.results);
    } catch (fetchError) {
      console.error(fetchError);
      setError("No se pudo cargar la informacion de usuarios.");
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchPeople();
  }, [fetchPeople]);

  const customerMap = useMemo(() => {
    const map = new Map<string, Customer>();
    customers.forEach((customer) => {
      map.set(customer.user, customer);
    });
    return map;
  }, [customers]);

  const combinedRows = useMemo(
    () => users.map((user) => ({ user, customer: customerMap.get(user.id) ?? null })),
    [users, customerMap],
  );

  const filteredRows = useMemo(() => {
    const term = search.trim().toLowerCase();
    return combinedRows.filter(({ user }) => {
      const matchesRole = roleFilter === "all" || user.role === roleFilter;
      if (!matchesRole) return false;
      if (!term) return true;
      const fullName = `${user.first_name} ${user.last_name}`.toLowerCase();
      return user.email.toLowerCase().includes(term) || fullName.includes(term);
    });
  }, [combinedRows, roleFilter, search]);

  const closeForm = () => {
    setIsFormOpen(false);
    setEditing(null);
    reset(defaultValues);
  };

  const openCreateModal = () => {
    setEditing(null);
    reset(defaultValues);
    setIsFormOpen(true);
  };

  const onSubmit = handleSubmit(async (values) => {
    setError(null);
    if (!editing && !values.password) {
      setFormError("password", { type: "manual", message: "La contrasena es obligatoria para crear usuarios." });
      return;
    }

    const payload: UserPayload = {
      email: values.email,
      password: values.password ? values.password : undefined,
      first_name: values.first_name ?? "",
      last_name: values.last_name ?? "",
      role: values.role,
      is_active: values.is_active,
    };

    try {
      let userResponse: User;
      if (editing) {
        userResponse = await updateUser(editing.id, payload);
      } else {
        userResponse = await createUser(payload);
      }

      if (values.role === "CLIENT") {
        const customerPayload: CustomerPayload = {
          user: userResponse.id,
          phone: values.phone ?? "",
          doc_id: values.doc_id ?? "",
        };
        const existingCustomer = customers.find((customer) => customer.user === userResponse.id);
        if (existingCustomer) {
          await updateCustomer(existingCustomer.id, customerPayload);
        } else {
          await createCustomer(customerPayload);
        }
      }

      await fetchPeople();
      closeForm();
    } catch (submitError) {
      console.error(submitError);
      setError("No se pudo guardar el usuario.");
    }
  });

  const handleEdit = (user: User) => {
    const customer = customerMap.get(user.id);
    setEditing(user);
    reset({
      email: user.email,
      password: "",
      first_name: user.first_name ?? "",
      last_name: user.last_name ?? "",
      role: user.role,
      is_active: user.is_active,
      phone: customer?.phone ?? "",
      doc_id: customer?.doc_id ?? "",
    });
    setIsFormOpen(true);
  };

  const handleDelete = async (user: User) => {
    const confirmed = window.confirm(`Eliminar el usuario ${user.email}?`);
    if (!confirmed) return;
    try {
      const customer = customers.find((item) => item.user === user.id);
      if (customer) {
        try {
          await deleteCustomer(customer.id);
        } catch (customerError) {
          if (!axios.isAxiosError(customerError) || customerError.response?.status !== 404) {
            throw customerError;
          }
        }
      }
      await deleteUser(user.id);
      await fetchPeople();
      if (editing?.id === user.id) {
        closeForm();
      }
    } catch (deleteError) {
      console.error(deleteError);
      setError("No se pudo eliminar el usuario.");
    }
  };

  const modalTitle = editing ? "Editar usuario" : "Nuevo usuario";

  return (
    <div className="mx-auto flex w-full max-w-6xl flex-col gap-6 px-6 py-6">
      <section className="flex flex-col gap-3 px-[10px] lg:flex-row lg:items-center lg:justify-between">
        <div className="space-y-1">
          <h1 className="text-2xl font-semibold text-white">Usuarios</h1>
          <p className="text-sm text-white/60">Administra administradores y clientes desde un solo lugar.</p>
        </div>
        <button
          type="button"
          className="h-12 rounded-full bg-primary px-6 text-sm font-semibold uppercase tracking-[0.3em] text-white shadow-lg shadow-primary/40 transition hover:bg-primary/90 disabled:cursor-not-allowed disabled:opacity-70"
          onClick={openCreateModal}
        >
          Nuevo usuario
        </button>
      </section>

      <form className="grid gap-3 px-[10px] md:grid-cols-[minmax(0,1fr)_minmax(0,0.6fr)_minmax(0,0.5fr)]">
          <div className="w-full sm:max-w-sm">
            <input
              className={filterControlClass}
              placeholder="Buscar por email o nombre"
              value={search}
              onChange={(event) => setSearch(event.target.value)}
            />
          </div>
          <div className="relative w-full sm:w-auto sm:min-w-[200px]">
            <select
              className={`${filterControlClass} appearance-none pr-12`}
              value={roleFilter}
              onChange={(event) => setRoleFilter(event.target.value as RoleFilter)}
            >
              <option value="all">Todos los roles</option>
              <option value="ADMIN">Administradores</option>
              <option value="CLIENT">Clientes</option>
            </select>
            <span className="pointer-events-none absolute inset-y-0 right-5 flex items-center text-white/40" aria-hidden="true">
              â–¼
            </span>
          </div>
        <button
          type="button"
          className="rounded-full border border-white/15 px-4 py-2 text-sm font-semibold uppercase tracking-[0.3em] text-white/70 transition hover:border-white/40 hover:text-white"
          onClick={fetchPeople}
        >
          Recargar
        </button>
      </form>

      {error ? (
        <div className="rounded-[24px] border border-red-500/40 bg-red-600/20 px-6 py-4 text-sm font-semibold text-red-100 shadow-[0_24px_48px_rgba(110,15,22,0.25)]">
          {error}
        </div>
      ) : null}

      <section className="rounded-[28px] border border-white/10 bg-[#041024]/90 shadow-[0_30px_70px_rgba(3,10,23,0.45)] backdrop-blur-xl">
        {loading ? (
          <div className="px-6 py-10 text-center text-sm font-semibold uppercase tracking-[0.3em] text-white/70">Cargando usuarios...</div>
        ) : filteredRows.length === 0 ? (
          <div className="px-6 py-10 text-center text-sm font-semibold uppercase tracking-[0.3em] text-white/70">
            No hay usuarios que coincidan con los filtros.
          </div>
        ) : (
          <>
            <div className="grid gap-4 md:hidden">
              {filteredRows.map(({ user, customer }) => (
                <article
                  key={user.id}
                  className="rounded-2xl border border-white/10 bg-[#0b254d]/70 p-4 text-sm text-white/85 shadow-inner shadow-black/20"
                >
                  <div className="flex flex-wrap items-start justify-between gap-3">
                    <div>
                      <p className="text-xs font-semibold uppercase tracking-[0.35em] text-white/60">Email</p>
                      <p className="text-base font-semibold text-white">{user.email}</p>
                      <p className="mt-1 text-xs text-white/70">
                        {user.first_name} {user.last_name}
                      </p>
                    </div>
                    <span className="inline-flex items-center rounded-full bg-white/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-white/80">
                      {user.role === "ADMIN" ? "Administrador" : "Cliente"}
                    </span>
                  </div>
                  <div className="mt-3 flex flex-wrap items-center gap-3 text-xs text-white/75">
                    <span
                      className={`inline-flex items-center rounded-full px-3 py-1 font-semibold uppercase tracking-[0.3em] ${
                        user.is_active ? "bg-green-500/15 text-green-300" : "bg-red-600/15 text-red-300"
                      }`}
                    >
                      {user.is_active ? "Activo" : "Inactivo"}
                    </span>
                    <span>Tel: {customer?.phone || "Sin registro"}</span>
                    <span>Doc: {customer?.doc_id || "N/A"}</span>
                  </div>
                  <div className="mt-4 flex flex-wrap items-center gap-2">
                    <button
                      type="button"
                      className="rounded-full border border-white/15 px-4 py-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-white/75 transition hover:border-white/40 hover:text-white"
                      onClick={() => handleEdit(user)}
                    >
                      Editar
                    </button>
                    <button
                      type="button"
                      className="rounded-full bg-red-600 px-4 py-2 text-[11px] font-semibold uppercase tracking-[0.3em] text-white shadow-lg shadow-red-600/40 transition hover:bg-red-500"
                      onClick={() => handleDelete(user)}
                    >
                      Eliminar
                    </button>
                  </div>
                </article>
              ))}
            </div>

            <div className="hidden md:block">
              <div className="overflow-x-auto">
                <table className="min-w-[640px] table-fixed divide-y divide-white/10 text-sm text-white/90">
                  <thead className="bg-[#0b254d]/70 text-[11px] font-semibold uppercase tracking-[0.3em] text-white/65">
                    <tr>
                      <th className="px-4 py-3 text-left">Email</th>
                      <th className="px-2 py-3 text-left">Nombre</th>
                      <th className="px-2 py-3 text-left">Rol</th>
                      <th className="px-2 py-3 text-center">Estado</th>
                      <th className="px-3 py-3 text-left">Telefono</th>
                      <th className="px-3 py-3 text-left">Documento</th>
                      <th className="px-3 py-3 text-right">Acciones</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-white/10">
                    {filteredRows.map(({ user, customer }) => (
                      <tr key={user.id} className="transition hover:bg-white/10">
                        <td className="px-4 py-3 font-semibold text-white">{user.email}</td>
                        <td className="px-2 py-3 text-white/80">
                          {user.first_name} {user.last_name}
                        </td>
                        <td className="px-2 py-3">
                          <span className="inline-flex items-center rounded-full bg-white/10 px-2.5 py-1 text-[11px] font-semibold uppercase tracking-[0.25em] text-white/80">
                            {user.role === "ADMIN" ? "Administrador" : "Cliente"}
                          </span>
                        </td>
                        <td className="px-2 py-3 text-center">
                          <span
                            className={`inline-flex h-2.5 w-2.5 items-center justify-center rounded-full ${
                              user.is_active ? "bg-green-400" : "bg-red-500"
                            }`}
                            title={user.is_active ? "Activo" : "Inactivo"}
                          />
                        </td>
                        <td className="px-3 py-3 text-white/80">{customer?.phone || "-"}</td>
                        <td className="px-3 py-3 text-white/80">{customer?.doc_id || "-"}</td>
                        <td className="px-3 py-3">
                          <div className="flex flex-wrap items-center justify-end gap-1.5">
                            <button
                              type="button"
                              className="rounded-full border border-white/15 px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.3em] text-white/75 transition hover:border-white/40 hover:text-white"
                              onClick={() => handleEdit(user)}
                            >
                              Editar
                            </button>
                            <button
                              type="button"
                              className="rounded-full bg-red-600 px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.3em] text-white shadow-lg shadow-red-600/40 transition hover:bg-red-500"
                              onClick={() => handleDelete(user)}
                            >
                              Eliminar
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </>
        )}
      </section>

      <Modal open={isFormOpen} title={modalTitle} onClose={closeForm}>
        <form className="flex flex-col gap-5" onSubmit={onSubmit}>
          <FormInput label="Email" type="email" {...register("email")} error={errors.email?.message} disabled={Boolean(editing)} />
          <FormInput
            label={editing ? "Nueva contrasena (opcional)" : "Contrasena"}
            type="password"
            placeholder="********"
            {...register("password")}
            error={errors.password?.message}
          />
          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <FormInput label="Nombre" {...register("first_name")} error={errors.first_name?.message} />
            <FormInput label="Apellidos" {...register("last_name")} error={errors.last_name?.message} />
          </div>
          <Select label="Rol" {...register("role")} error={errors.role?.message}>
            <option value="ADMIN">Administrador</option>
            <option value="CLIENT">Cliente</option>
          </Select>
          <label className="flex items-center gap-3 rounded-2xl border border-slate-200 bg-slate-100 px-4 py-3 text-sm font-semibold text-slate-700">
            <input type="checkbox" className="h-4 w-4 text-primary focus:ring-primary" {...register("is_active")} /> Usuario activo
          </label>
          <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
            <FormInput label="Telefono" placeholder="+34..." {...register("phone")} error={errors.phone?.message} />
            <FormInput label="Documento" placeholder="DNI/NIE" {...register("doc_id")} error={errors.doc_id?.message} />
          </div>
          <div className="flex flex-wrap items-center justify-end gap-3">
            <button
              type="button"
              className="rounded-full border border-slate-300 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-slate-600 transition hover:border-primary hover:text-primary"
              onClick={closeForm}
              disabled={isSubmitting}
            >
              Cancelar
            </button>
            <button
              type="submit"
              className="rounded-full bg-red-600 px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white shadow-lg shadow-red-600/40 transition hover:bg-red-500 disabled:cursor-not-allowed disabled:opacity-70"
              disabled={isSubmitting}
            >
              {isSubmitting ? "Guardando..." : editing ? "Actualizar" : "Crear"}
            </button>
          </div>
        </form>
      </Modal>
    </div>
  );
}
